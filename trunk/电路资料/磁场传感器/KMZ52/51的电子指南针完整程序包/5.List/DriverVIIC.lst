C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE DRIVERVIIC
OBJECT MODULE PLACED IN .\4.Obj\DriverVIIC.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE 3.Source\DriverVIIC.c BROWSE INCDIR(.\2.Inc) DEBUG OBJECTEXTEND PRINT(.\5.L
                    -ist\DriverVIIC.lst) OBJECT(.\4.Obj\DriverVIIC.obj)

line level    source

   1          /**********************************************************************************************
   2          ***Ä£¿éÃû³Æ£º VIIC.c                                                                        ***
   3          ***Ä£¿é¹¦ÄÜ£º ¶Ë¿ÚÄ£ÄâIIC×ÜÏßÊ±Ðò                                                           ***           
             -                                                                                         
   4          ***×÷    Õß£º METAL MAX £¬liyangbbs@126.com                                                 ***
   5          ***µ÷ÓÃ·½Ê½£º                                                                               ***
   6          ***ÈÕ    Ö¾£º ÈÕÆÚ        °æ±¾    ÐÞ¸ÄÈË      ÊÂ¼þ                                          ***
   7          ***           2008/5/27   V0.01   METAL MAX   ´î½¨³ÌÐò¿ò¼Ü                                  ***
   8          ***±¸    ×¢£º ³ÌÐòÄÚ²¿²ÉÓÃµÄÈí¼þÑÓ³ÙµÄ·½·¨µÃµ½ÑÓ³ÙÊ±¼ä                                      ***
   9          **********************************************************************************************/  
  10          #include <reg52.h>          
  11          #include <intrins.h>
  12          #include "PinDefine.h"
  13          bit ack;                                                                    /* Ó¦´ð±êÖ¾Î»                        
             -               */
  14          
  15          /*********************************************************************************************************
             -*******************
  16          **º¯ÊýÃû³Æ£º void  IICStart()                                                                             
             -                 **
  17          **º¯Êý¹¦ÄÜ£º Æð¶¯×ÜÏßº¯Êý                                                                                 
             -                 **   
  18          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
  19          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
  20          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
  21          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
  22          **±¸    ×¢£º                                                                                              
             -                 **
  23          **********************************************************************************************************
             -******************/
  24          void IICStart(void)
  25          {
  26   1          SDA = 1;                                                            /* ·¢ËÍÆðÊ¼Ìõ¼þµÄÊý¾ÝÐÅºÅ         
             -                  */
  27   1          _nop_();
  28   1          SCL = 1;
  29   1          _nop_();                                                            /* ÆðÊ¼½¨Á¢Ê±¼ä´óÓÚ4.7us,ÑÓÊ±     
             -                  */
  30   1          _nop_();
  31   1          _nop_();
  32   1          _nop_();
  33   1          _nop_();    
  34   1          SDA = 0;                                                            /* ·¢ËÍÆðÊ¼ÐÅºÅ                   
             -                  */
  35   1          _nop_();                                                            /* ÆðÊ¼Ìõ¼þËø¶¨Ê±¼ä´óÓÚ4¦Ìs       
             -                  */
  36   1          _nop_();
  37   1          _nop_();
  38   1          _nop_();
  39   1          _nop_();       
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 2   

  40   1          SCL = 0;                                                            /* Ç¯×¡I2C×ÜÏß£¬×¼±¸·¢ËÍ»ò½ÓÊÕÊý¾Ý
             -                  */
  41   1          _nop_();
  42   1          _nop_();
  43   1      }
  44          
  45          
  46          /*********************************************************************************************************
             -*******************
  47          **º¯ÊýÃû³Æ£º void  IICStop()                                                                              
             -                 **
  48          **º¯Êý¹¦ÄÜ£º ½áÊø×ÜÏßº¯Êý                                                                                 
             -                 **   
  49          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
  50          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
  51          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
  52          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
  53          **±¸    ×¢£º                                                                                              
             -                 **
  54          **********************************************************************************************************
             -******************/
  55          void IICStop(void)
  56          {
  57   1          SDA = 0;                                                            /* ·¢ËÍ½áÊøÌõ¼þµÄÊý¾ÝÐÅºÅ         
             -                  */
  58   1          _nop_();                                                            /* ·¢ËÍ½áÊøÌõ¼þµÄÊ±ÖÓÐÅºÅ         
             -                  */
  59   1          SCL = 1;                                                            /* ½áÊøÌõ¼þ½¨Á¢Ê±¼ä´óÓÚ4¦Ìs       
             -                  */
  60   1          _nop_();
  61   1          _nop_();
  62   1          _nop_();
  63   1          _nop_();
  64   1          _nop_();
  65   1          SDA = 1;                                                            /* ·¢ËÍI2C×ÜÏß½áÊøÐÅºÅ            
             -                  */
  66   1          _nop_();
  67   1          _nop_();
  68   1          _nop_();
  69   1          _nop_();
  70   1      }
  71           
  72          
  73          /*********************************************************************************************************
             -********************
  74          **º¯ÊýÃû³Æ£º void  SendByte(unsigned char dat)                                                            
             -                  **
  75          **º¯Êý¹¦ÄÜ£º ×Ö½ÚÊý¾Ý´«ËÍº¯Êý                                                                             
             -                  **   
  76          **Èë¿Ú²ÎÊý£º                                                                                              
             -                  **
  77          **³ö¿Ú²ÎÊý£º                                                                                              
             -                  **
  78          **¾ßÌå×ÊÔ´£º                                                                                              
             -                  **
  79          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                  **
  80          **±¸    ×¢£º                                                                                              
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 3   

             -                  **
  81          **********************************************************************************************************
             -*******************/
  82          void  SendByte(unsigned char dat)
  83          {
  84   1          unsigned char BitCnt;
  85   1      
  86   1          for (BitCnt=0; BitCnt<8; BitCnt++) {                                /* Òª´«ËÍµÄÊý¾Ý³¤¶ÈÎª8Î»          
             -                  */
  87   2              if ((dat << BitCnt) & 0x80) {
  88   3                  SDA = 1;                                                    /* ÅÐ¶Ï·¢ËÍÎ»                     
             -                  */
  89   3              } else {
  90   3                  SDA = 0;
  91   3              }                     
  92   2           _nop_();
  93   2           SCL = 1;                                                           /* ÖÃÊ±ÖÓÏßÎª¸ß£¬Í¨Öª±»¿ØÆ÷¿ªÊ¼½ÓÊ
             -ÕÊý¾ÝÎ»           */
  94   2           _nop_(); 
  95   2           _nop_();                                                           /* ±£Ö¤Ê±ÖÓ¸ßµçÆ½ÖÜÆÚ´óÓÚ4¦Ìs     
             -                  */
  96   2           _nop_();
  97   2           _nop_();
  98   2           _nop_();         
  99   2           SCL = 0; 
 100   2          }
 101   1          _nop_();
 102   1          _nop_();
 103   1          SDA = 1;                                                            /* 8Î»·¢ËÍÍêºóÊÍ·ÅÊý¾ÝÏß£¬×¼±¸½ÓÊÕ
             -Ó¦´ðÎ»          */
 104   1          _nop_();
 105   1          _nop_();   
 106   1          SCL = 1;
 107   1          _nop_();
 108   1          _nop_();
 109   1          _nop_();
 110   1          if (SDA == 1) {
 111   2              ack = 0;
 112   2          } else {
 113   2              ack = 1;
 114   2          }                                                                   /* ÅÐ¶ÏÊÇ·ñ½ÓÊÕµ½Ó¦´ðÐÅºÅ       */
 115   1          SCL=0;
 116   1          _nop_();
 117   1          _nop_();
 118   1      }
 119          
 120                  
 121          /*********************************************************************************************************
             -*******************
 122          **º¯ÊýÃû³Æ£º unsigned char  RcvByte()                                                                     
             -                         **
 123          **º¯Êý¹¦ÄÜ£º ×Ö½ÚÊý¾Ý´«ËÍº¯Êý                                                                             
             -                 **   
 124          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
 125          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
 126          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
 127          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
 128          **±¸    ×¢£º                                                                                              
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 4   

             -                 **
 129          **********************************************************************************************************
             -******************/
 130          unsigned char  RcvByte(void)
 131          {
 132   1          unsigned char retc;
 133   1          unsigned char BitCnt;
 134   1        
 135   1          retc=0; 
 136   1          SDA=1;                                                              /* ÖÃÊý¾ÝÏßÎªÊäÈë·½Ê½             
             -                  */
 137   1          for (BitCnt=0; BitCnt<8; BitCnt++) {
 138   2              _nop_();           
 139   2              SCL=0;                                                          /* ÖÃÊ±ÖÓÏßÎªµÍ£¬×¼±¸½ÓÊÕÊý¾ÝÎ»   
             -                  */
 140   2              _nop_();
 141   2              _nop_();                                                        /* Ê±ÖÓµÍµçÆ½ÖÜÆÚ´óÓÚ4.7¦Ìs       
             -                  */
 142   2              _nop_();
 143   2              _nop_();
 144   2              _nop_();
 145   2              SCL=1;                                                          /* ÖÃÊ±ÖÓÏßÎª¸ßÊ¹Êý¾ÝÏßÉÏÊý¾ÝÓÐÐ§ 
             -                  */
 146   2              _nop_();
 147   2              _nop_();
 148   2              retc = retc<<1;
 149   2              if (SDA == 1) {
 150   3                  retc = retc+1;                                              /* ¶ÁÊý¾ÝÎ»,½ÓÊÕµÄÊý¾ÝÎ»·ÅÈëretcÖÐ
             -                  */
 151   3              }
 152   2              _nop_();
 153   2              _nop_(); 
 154   2          }
 155   1          SCL=0;    
 156   1          _nop_();
 157   1          _nop_();
 158   1          return(retc);
 159   1      }
 160          
 161          
 162          /*********************************************************************************************************
             -*******************
 163          **º¯ÊýÃû³Æ£º ACK(bit a)                                                                                   
             -                 **
 164          **º¯Êý¹¦ÄÜ£º Ó¦´ð×Óº¯Êý                                                                                   
             -                 **   
 165          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
 166          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
 167          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
 168          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
 169          **±¸    ×¢£º                                                                                              
             -                 **
 170          **********************************************************************************************************
             -******************/
 171          void IICACK(bit ack)
 172          {
 173   1        
 174   1          if (ack == 0) {
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 5   

 175   2              SDA=0;                                                          /* ÔÚ´Ë·¢³öÓ¦´ð»ò·ÇÓ¦´ðÐÅºÅ       
             -                  */
 176   2          } else {
 177   2              SDA=1;
 178   2          }
 179   1          _nop_();
 180   1          _nop_();
 181   1          _nop_();      
 182   1          SCL = 1;
 183   1          _nop_();
 184   1          _nop_();                                                            /* Ê±ÖÓµÍµçÆ½ÖÜÆÚ´óÓÚ4¦Ìs         
             -                  */
 185   1          _nop_();
 186   1          _nop_();
 187   1          _nop_();  
 188   1          SCL = 0;                                                            /* ÇåÊ±ÖÓÏß£¬Ç¯×¡I2C×ÜÏßÒÔ±ã¼ÌÐø½Ó
             -ÊÕ                */
 189   1          _nop_();
 190   1          _nop_();    
 191   1      }
 192          
 193          
 194          /*********************************************************************************************************
             -*******************
 195          **º¯ÊýÃû³Æ£º bit  ISendByte(unsigned char slave,ucahr dat)                                                
             -                 **
 196          **º¯Êý¹¦ÄÜ£º ÏòÎÞ×ÓµØÖ·Æ÷¼þ·¢ËÍ×Ö½ÚÊý¾Ýº¯Êý                                                               
             -                 **   
 197          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
 198          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
 199          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
 200          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
 201          **±¸    ×¢£º                                                                                              
             -                 **
 202          **********************************************************************************************************
             -******************/
 203          bit ISendByte(unsigned char slave,unsigned char dat)
 204          {
 205   1              IICStart();                                                         /* Æô¶¯×ÜÏß                          
             -               */
 206   1              SendByte(slave);                                                    /* ·¢ËÍÆ÷¼þµØÖ·                      
             -               */
 207   1          if (ack == 0)return(0);
 208   1              SendByte(dat);                                                      /* ·¢ËÍÊý¾Ý                          
             -               */
 209   1              if (ack == 0)return(0);
 210   1              IICStop();                                                          /* ½áÊø×ÜÏß                          
             -               */ 
 211   1              return(1);
 212   1      }
 213          
 214          
 215          /*********************************************************************************************************
             -*******************
 216          **º¯ÊýÃû³Æ£º bit ISendStr(unsigned char slave, unsigned char subaddr, unsigned char *p, unsigned char num)
             -                 **
 217          **º¯Êý¹¦ÄÜ£º ÏòÓÐ×ÓµØÖ·Æ÷¼þ·¢ËÍ¶à×Ö½ÚÊý¾Ýº¯Êý                                                             
             -                 **   
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 6   

 218          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
 219          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
 220          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
 221          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
 222          **±¸    ×¢£º                                                                                              
             -                 **
 223          **********************************************************************************************************
             -******************/
 224          bit ISendStr(unsigned char slave, unsigned char subaddr, unsigned char *p, unsigned char num)
 225          {
 226   1          unsigned char i;
 227   1      
 228   1          IICStart();                                                         /* Æô¶¯×ÜÏß                       
             -                  */
 229   1          SendByte(slave);                                                    /* ·¢ËÍÆ÷¼þµØÖ·                   
             -                  */
 230   1          if (ack == 0)return(0);
 231   1          SendByte(subaddr);                                                  /* ·¢ËÍÆ÷¼þ×ÓµØÖ·                 
             -                  */
 232   1          if (ack == 0)return(0);
 233   1      
 234   1          for (i=0; i<num; i++) {   
 235   2              SendByte(*p);                                                   /* ·¢ËÍÊý¾Ý                       
             -                  */
 236   2              if (ack == 0)return(0);
 237   2              p++;
 238   2          } 
 239   1          IICStop();                                                          /* ½áÊø×ÜÏß                       
             -                  */ 
 240   1          return(1);
 241   1      }
 242          
 243          
 244          /*********************************************************************************************************
             -*******************
 245          **º¯ÊýÃû³Æ£º bit  IRcvByte(unsigned char slave,ucahr *dat)                                                
             -                                                              **
 246          **º¯Êý¹¦ÄÜ£º ÏòÎÞ×ÓµØÖ·Æ÷¼þ¶Á×Ö½ÚÊý¾Ýº¯Êý                                                                 
             -                                             **   
 247          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
 248          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
 249          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
 250          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
 251          **±¸    ×¢£º                                                                                              
             -                 **
 252          **********************************************************************************************************
             -******************/
 253          bit IRcvByte(unsigned char slave,unsigned char *dat)
 254          {
 255   1         IICStart();                                                          /* Æô¶¯×ÜÏß                       
             -                  */
 256   1         SendByte(slave+1);                                                   /* ·¢ËÍÆ÷¼þµØÖ·                   
             -                  */
 257   1         if(ack == 0)return(0);
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 7   

 258   1         *dat = RcvByte();                                                      /* ¶ÁÈ¡Êý¾Ý                     
             -                    */
 259   1         IICACK(1);                                                           /* ·¢ËÍ·Ç¾Í´ðÎ»                   
             -                  */
 260   1         IICStop();                                                           /* ½áÊø×ÜÏß                       
             -                  */ 
 261   1         return(1);
 262   1      }
 263          
 264          
 265          /*********************************************************************************************************
             -*******************
 266          **º¯ÊýÃû³Æ£º bit  ISendStr(unsigned char slave, unsigned char subaddr, ucahr *p, unsigned char num)       
             -                                                                                                       **
 267          **º¯Êý¹¦ÄÜ£º ÏòÓÐ×ÓµØÖ·Æ÷¼þ¶ÁÈ¡¶à×Ö½ÚÊý¾Ýº¯Êý                                                             
             -                                                 **   
 268          **Èë¿Ú²ÎÊý£º                                                                                              
             -                 **
 269          **³ö¿Ú²ÎÊý£º                                                                                              
             -                 **
 270          **¾ßÌå×ÊÔ´£º                                                                                              
             -                 **
 271          **µ÷ÓÃ³ÌÐò£º                                                                                              
             -                 **
 272          **±¸    ×¢£º                                                                                              
             -                 **
 273          **********************************************************************************************************
             -******************/
 274          bit IRcvStr(unsigned char slave, unsigned char subaddr, unsigned char *p, unsigned char num)
 275          {
 276   1          unsigned char Cnt = 0;
 277   1      
 278   1          IICStart();                                                         /* Æô¶¯×ÜÏß                       
             -                  */
 279   1          SendByte(slave);                                                    /* ·¢ËÍÆ÷¼þµØÖ·                   
             -                  */
 280   1          if (ack == 0)return(0);
 281   1          SendByte(subaddr);                                                  /* ·¢ËÍÆ÷¼þ×ÓµØÖ·                 
             -                  */
 282   1          if (ack == 0)return(0);
 283   1      
 284   1          IICStart();
 285   1          SendByte(slave+1);
 286   1          if (ack == 0)return(0);
 287   1      
 288   1          for (Cnt=0; Cnt < (num-1); Cnt++) {   
 289   2              *p = RcvByte();                                                 /* ·¢ËÍÊý¾Ý                       
             -                  */
 290   2              IICACK(0);                                                      /* ·¢ËÍ¾Í´ðÎ»                     
             -                  */  
 291   2              p++;
 292   2          } 
 293   1          *p = RcvByte();
 294   1          IICACK(1);                
 295   1          IICStop();                 
 296   1          return(1);
 297   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    353    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V8.08   DRIVERVIIC                                                            06/18/2008 01:56:31 PAGE 8   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
